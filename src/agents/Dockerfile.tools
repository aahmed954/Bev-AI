# Tool Coordinator Container - 100+ Tool Management & Load Balancing
FROM python:3.11-slim

LABEL maintainer="ORACLE1 Tool Systems"
LABEL component="tool-coordinator"
LABEL version="3.0.0"

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    curl \
    wget \
    netcat-openbsd \
    dnsutils \
    iputils-ping \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Install Python dependencies
RUN pip install --no-cache-dir \
    fastapi==0.104.1 \
    uvicorn==0.24.0 \
    aiohttp==3.9.1 \
    httpx==0.25.2 \
    grpcio==1.60.0 \
    grpcio-tools==1.60.0 \
    consul-py==1.1.0 \
    etcd3==0.12.0 \
    kazoo==2.9.0 \
    aiokafka==0.10.0 \
    redis==5.0.1 \
    celery==5.3.4 \
    flower==2.0.1 \
    prometheus-client==0.19.0 \
    structlog==23.2.0 \
    tenacity==8.2.3 \
    pydantic==2.5.0 \
    jsonschema==4.20.0 \
    pyyaml==6.0.1 \
    toml==0.10.2 \
    jinja2==3.1.2 \
    marshmallow==3.20.1 \
    pendulum==3.0.0 \
    circuitbreaker==2.0.0 \
    aiocache==0.12.2

# Copy tool coordinator code
COPY tool_coordinator.py /app/
COPY tool_registry/ /app/tool_registry/
COPY tool_adapters/ /app/tool_adapters/
COPY load_balancer/ /app/load_balancer/

# Create necessary directories
RUN mkdir -p /app/logs /app/data /app/tool_cache /app/metrics

# Expose ports
EXPOSE 8500  # API port
EXPOSE 9500  # Metrics port
EXPOSE 8501  # Tool registry port
EXPOSE 6060  # Health check aggregator

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8500/health || exit 1

# Environment variables
ENV MAX_TOOLS="100" \
    TOOL_TIMEOUT="30" \
    LOAD_BALANCER="round_robin" \
    CIRCUIT_BREAKER_THRESHOLD="5" \
    HEALTH_CHECK_INTERVAL="60" \
    TOOL_CACHE_TTL="300" \
    SERVICE_DISCOVERY="consul" \
    LOG_LEVEL="INFO"

# Run tool coordinator
CMD ["uvicorn", "tool_coordinator:app", "--host", "0.0.0.0", "--port", "8500", "--workers", "4"]