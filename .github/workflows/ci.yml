name: "BEV OSINT Framework - Comprehensive CI Pipeline"

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["main", "enterprise-completion"]
  workflow_dispatch:
    inputs:
      enable_parallel_builds:
        description: "Enable parallel Docker builds"
        type: boolean
        default: true
      run_performance_tests:
        description: "Run performance benchmarks"
        type: boolean
        default: false
      target_architecture:
        description: "Target architecture for builds"
        type: choice
        default: "multi"
        options:
          - "amd64"
          - "arm64"
          - "multi"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: "3.13"
  NODE_VERSION: "22"
  DOCKER_BUILDKIT: 1
  BUILDX_EXPERIMENTAL: 1

jobs:
  # ============================================================================
  # Pre-flight Checks and Environment Setup
  # ============================================================================
  
  preflight:
    name: "ğŸ” Pre-flight Validation"
    runs-on: ubuntu-latest
    outputs:
      should_run_parallel: ${{ steps.config.outputs.parallel_builds }}
      architecture_matrix: ${{ steps.config.outputs.arch_matrix }}
      docker_files_changed: ${{ steps.changes.outputs.docker_files }}
      python_files_changed: ${{ steps.changes.outputs.python_files }}
      frontend_files_changed: ${{ steps.changes.outputs.frontend_files }}
      skip_heavy_tests: ${{ steps.config.outputs.skip_heavy }}
    
    steps:
      - name: "ğŸ“‹ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ”§ Configure build parameters"
        id: config
        run: |
          # Determine parallel builds
          if [[ "${{ github.event.inputs.enable_parallel_builds }}" == "true" ]] || [[ "${{ github.event_name }}" == "push" ]]; then
            echo "parallel_builds=true" >> $GITHUB_OUTPUT
          else
            echo "parallel_builds=false" >> $GITHUB_OUTPUT
          fi
          
          # Architecture matrix
          case "${{ github.event.inputs.target_architecture || 'multi' }}" in
            "amd64") echo "arch_matrix=[\"linux/amd64\"]" >> $GITHUB_OUTPUT ;;
            "arm64") echo "arch_matrix=[\"linux/arm64\"]" >> $GITHUB_OUTPUT ;;
            *) echo "arch_matrix=[\"linux/amd64\", \"linux/arm64\"]" >> $GITHUB_OUTPUT ;;
          esac
          
          # Skip heavy tests for draft PRs
          if [[ "${{ github.event.pull_request.draft }}" == "true" ]]; then
            echo "skip_heavy=true" >> $GITHUB_OUTPUT
          else
            echo "skip_heavy=false" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ“ Detect changed files"
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docker_files:
              - 'Dockerfile*'
              - 'docker-compose*.yml'
              - 'deployment/**'
            python_files:
              - 'src/**/*.py'
              - 'tests/**/*.py'
              - 'requirements*.txt'
              - 'pyproject.toml'
            frontend_files:
              - 'bev-frontend/**'
              - 'cytoscape/**'
              - 'package*.json'

      - name: "ğŸ“Š Validate project structure"
        run: |
          echo "ğŸ” Validating BEV project structure..."
          
          # Check critical directories
          required_dirs=(
            "src/mcp_server"
            "src/pipeline" 
            "intelowl/custom_analyzers"
            "tests"
            "deployment"
          )
          
          for dir in "${required_dirs[@]}"; do
            if [[ ! -d "$dir" ]]; then
              echo "âŒ Missing required directory: $dir"
              exit 1
            fi
          done
          
          # Check Dockerfile count
          dockerfile_count=$(find . -name "Dockerfile*" -type f | wc -l)
          echo "ğŸ“¦ Found $dockerfile_count Dockerfiles"
          
          if [[ $dockerfile_count -lt 20 ]]; then
            echo "âš ï¸ Warning: Expected 50+ Dockerfiles for complete BEV platform"
          fi
          
          echo "âœ… Project structure validation passed"

  # ============================================================================
  # Code Quality and Security Analysis
  # ============================================================================

  code-quality:
    name: "ğŸ” Code Quality Analysis"
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.python_files_changed == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: "ğŸ“‹ Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python ${{ env.PYTHON_VERSION }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: "ğŸ“¦ Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black flake8 mypy pytest-cov bandit safety

      - name: "ğŸ¨ Code formatting (Black)"
        run: |
          echo "ğŸ¨ Running Black formatter..."
          python -m black --check --diff src/ tests/
          
      - name: "ğŸ” Linting (Flake8)"
        run: |
          echo "ğŸ” Running Flake8 linter..."
          python -m flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503

      - name: "ğŸ”¬ Type checking (MyPy)"
        run: |
          echo "ğŸ”¬ Running MyPy type checker..."
          python -m mypy src/ --ignore-missing-imports

      - name: "ğŸ›¡ï¸ Security scanning (Bandit)"
        run: |
          echo "ğŸ›¡ï¸ Running Bandit security scanner..."
          python -m bandit -r src/ -f json -o bandit-report.json
          python -m bandit -r src/ --severity-level medium

      - name: "ğŸ“¦ Dependency vulnerability check"
        run: |
          echo "ğŸ“¦ Checking dependencies for vulnerabilities..."
          python -m safety check --json --output safety-report.json || true
          python -m safety check

      - name: "ğŸ“Š Upload security reports"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # ============================================================================
  # Python Testing Suite
  # ============================================================================

  python-tests:
    name: "ğŸ§ª Python Test Suite"
    runs-on: ubuntu-latest
    needs: [preflight, code-quality]
    if: needs.preflight.outputs.python_files_changed == 'true' || github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        test-category: ["unit", "integration", "security"]
        
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: researcher
          POSTGRES_PASSWORD: SecureResearchPass2024
          POSTGRES_DB: osint
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: "ğŸ“‹ Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python ${{ env.PYTHON_VERSION }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: "ğŸ“¦ Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist pytest-mock

      - name: "ğŸ”§ Setup test environment"
        run: |
          echo "ğŸ”§ Setting up test environment for ${{ matrix.test-category }}..."
          
          # Create test configuration
          cp .env.example .env.test
          
          # Setup test database
          export PGPASSWORD=SecureResearchPass2024
          psql -h localhost -U researcher -d osint -c "CREATE EXTENSION IF NOT EXISTS vector;"

      - name: "ğŸ§ª Run ${{ matrix.test-category }} tests"
        run: |
          case "${{ matrix.test-category }}" in
            "unit")
              echo "ğŸ§ª Running unit tests..."
              python -m pytest tests/unit/ -v --cov=src --cov-report=xml --cov-report=term
              ;;
            "integration") 
              echo "ğŸ”— Running integration tests..."
              python -m pytest tests/integration/ -v --maxfail=5
              ;;
            "security")
              echo "ğŸ›¡ï¸ Running security tests..."
              python -m pytest tests/security/ -v --tb=short
              ;;
          esac

      - name: "ğŸ“Š Upload test results"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-category }}
          path: |
            coverage.xml
            pytest-report.xml

  # ============================================================================
  # Docker Build Matrix (Parallel Builds)
  # ============================================================================

  docker-build-matrix:
    name: "ğŸ³ Docker Build Matrix"
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.docker_files_changed == 'true' || github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        dockerfile:
          - { name: "bev-core", file: "Dockerfile", context: "." }
          - { name: "mcp-server", file: "Dockerfile.mcp_server", context: "." }
          - { name: "osint-integration", file: "Dockerfile.osint-integration", context: "." }
          - { name: "intel-fusion", file: "Dockerfile.intel_fusion", context: "." }
          - { name: "crypto-analyzer", file: "Dockerfile.crypto_analyzer", context: "." }
          - { name: "dm-crawler", file: "Dockerfile.dm_crawler", context: "." }
          - { name: "multiplexer", file: "Dockerfile.multiplexer", context: "." }
          - { name: "adaptive-learning", file: "Dockerfile.adaptive_learning", context: "." }
          - { name: "enhanced-controller", file: "Dockerfile.enhanced_autonomous_controller", context: "." }
          - { name: "knowledge-evolution", file: "Dockerfile.knowledge_evolution", context: "." }
          - { name: "reputation-analyzer", file: "Dockerfile.reputation_analyzer", context: "." }
          - { name: "resource-optimizer", file: "Dockerfile.resource_optimizer", context: "." }
          - { name: "tactical-intelligence", file: "Dockerfile.tactical_intelligence", context: "." }
          - { name: "defense-automation", file: "Dockerfile.defense_automation", context: "." }
          - { name: "opsec-enforcer", file: "Dockerfile.opsec_enforcer", context: "." }
          - { name: "economics-processor", file: "Dockerfile.economics_processor", context: "." }
        platform: ${{ fromJson(needs.preflight.outputs.architecture_matrix) }}
        
    steps:
      - name: "ğŸ“‹ Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ”§ Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: "ğŸ—ï¸ Build ${{ matrix.dockerfile.name }} for ${{ matrix.platform }}"
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.dockerfile.context }}
          file: ${{ matrix.dockerfile.file }}
          platforms: ${{ matrix.platform }}
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.dockerfile.name }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.dockerfile.name }}:latest

      - name: "ğŸ” Container security scan"
        if: matrix.platform == 'linux/amd64'
        run: |
          echo "ğŸ” Scanning ${{ matrix.dockerfile.name }} for vulnerabilities..."
          # docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          #   aquasec/trivy:latest image \
          #   ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.dockerfile.name }}:${{ github.sha }}

  # ============================================================================
  # Frontend Testing and Building
  # ============================================================================

  frontend-tests:
    name: "ğŸ¨ Frontend Tests & Build"
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.frontend_files_changed == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: "ğŸ“‹ Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'bev-frontend/package-lock.json'

      - name: "ğŸ“¦ Install frontend dependencies"
        working-directory: bev-frontend
        run: npm ci

      - name: "ğŸ” Frontend linting"
        working-directory: bev-frontend
        run: npm run lint

      - name: "ğŸ§ª Frontend unit tests"
        working-directory: bev-frontend
        run: npm run test

      - name: "ğŸ—ï¸ Frontend build"
        working-directory: bev-frontend
        run: npm run build

      - name: "ğŸ“Š Upload frontend artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: bev-frontend/dist/

  # ============================================================================
  # Performance Testing (Conditional)
  # ============================================================================

  performance-tests:
    name: "âš¡ Performance Benchmarks"
    runs-on: ubuntu-latest
    needs: [preflight, python-tests]
    if: github.event.inputs.run_performance_tests == 'true' && needs.preflight.outputs.skip_heavy_tests == 'false'
    
    steps:
      - name: "ğŸ“‹ Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python ${{ env.PYTHON_VERSION }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: "ğŸš€ Start performance test environment"
        run: |
          echo "ğŸš€ Starting lightweight performance test stack..."
          docker-compose -f docker-compose.test-basic.yml up -d
          sleep 30

      - name: "âš¡ Run performance benchmarks"
        run: |
          echo "âš¡ Running performance benchmarks..."
          python -m pytest tests/performance/ -v --benchmark-only
          
      - name: "ğŸ“Š Performance baseline check"
        run: |
          echo "ğŸ“Š Checking performance against baseline..."
          python tests/performance/baseline_validator.py

      - name: "ğŸ§¹ Cleanup performance environment"
        if: always()
        run: |
          docker-compose -f docker-compose.test-basic.yml down -v

  # ============================================================================
  # Final Validation and Summary
  # ============================================================================

  validation-summary:
    name: "âœ… CI Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [preflight, code-quality, python-tests, docker-build-matrix, frontend-tests]
    if: always()
    
    steps:
      - name: "ğŸ“‹ Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ“Š Generate CI summary"
        run: |
          echo "# ğŸš€ BEV OSINT Framework - CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Job status summary
          echo "## ğŸ“‹ Job Status Overview" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-flight | ${{ needs.preflight.result }} | Environment validation |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} | Formatting, linting, type checking |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.python-tests.result }} | Unit, integration, security tests |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Builds | ${{ needs.docker-build-matrix.result }} | Multi-architecture container builds |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.frontend-tests.result }} | UI component testing and building |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Configuration summary
          echo "## âš™ï¸ Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Parallel Builds**: ${{ needs.preflight.outputs.should_run_parallel }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Architectures**: ${{ needs.preflight.outputs.architecture_matrix }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Version**: ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Version**: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Next steps
          echo "## ğŸ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "- Review and merge pull request" >> $GITHUB_STEP_SUMMARY
            echo "- Deploy to staging environment" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Trigger deployment pipeline" >> $GITHUB_STEP_SUMMARY
            echo "- Run extended validation tests" >> $GITHUB_STEP_SUMMARY
          fi

      - name: "ğŸ¯ Determine overall status"
        run: |
          # Check if any critical jobs failed
          if [[ "${{ needs.code-quality.result }}" == "failure" ]] || [[ "${{ needs.python-tests.result }}" == "failure" ]]; then
            echo "âŒ CI Pipeline failed - critical issues detected"
            exit 1
          elif [[ "${{ needs.docker-build-matrix.result }}" == "failure" ]]; then
            echo "âš ï¸ CI Pipeline completed with Docker build warnings"
            exit 0
          else
            echo "âœ… CI Pipeline completed successfully"
            exit 0
          fi